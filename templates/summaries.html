{% extends "base.html" %}

{% block title %}月度总结 - lvy- 技术博客作品集{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">
            <i class="fas fa-chart-line me-2"></i>月度总结
        </h1>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="toggleAllSummaries()">
                <i class="fas fa-expand-arrows-alt me-1"></i>展开/收起全部
            </button>
            <a href="/generate-summary" class="btn btn-primary">
                <i class="fas fa-magic me-1"></i>重新生成总结
            </a>
        </div>
    </div>

    {% if summaries %}
    <!-- 总体统计 -->
    <div class="row mb-5">
        <div class="col-md-3">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <i class="fas fa-calendar-check fa-2x mb-3"></i>
                    <div class="stats-number">{{ summaries|length }}</div>
                    <div>活跃月份</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <i class="fas fa-edit fa-2x mb-3"></i>
                    <div class="stats-number">{{ total_articles_in_summaries }}</div>
                    <div>总文章数</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <i class="fas fa-trending-up fa-2x mb-3"></i>
                    <div class="stats-number">{{ avg_articles_per_month }}</div>
                    <div>月均发文</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <i class="fas fa-fire fa-2x mb-3"></i>
                    <div class="stats-number">{{ most_productive_month }}</div>
                    <div>最活跃月份</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 月度总结列表 -->
    {% for month_key, summary_data in summaries.items() %}
    <div class="month-section">
        <div class="month-header d-flex justify-content-between align-items-center">
            <h3 class="mb-0">
                <i class="fas fa-calendar-alt me-2"></i>
                {{ month_key }} 月度总结
                <span class="badge bg-light text-dark ms-2">{{ summary_data.article_count }}篇文章</span>
            </h3>
            <button class="btn btn-sm btn-light" type="button" 
                    data-bs-toggle="collapse" data-bs-target="#summary-{{ loop.index }}" 
                    aria-expanded="false">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>

        <div class="collapse" id="summary-{{ loop.index }}">
            <!-- AI生成的总结 -->
            <div class="summary-content">
                <div class="markdown-content">
                    {{ summary_data.summary | safe }}
                </div>
            </div>

            <!-- 该月文章列表 -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        本月文章列表 ({{ summary_data.article_count }}篇)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for article in summary_data.articles %}
                        <div class="col-lg-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <a href="{{ article.url }}" target="_blank" class="article-title">
                                            {{ article.title }}
                                        </a>
                                    </h6>
                                    <div class="article-meta">
                                        {{ article.publish_time }}
                                    </div>
                                    <div class="article-stats mt-2">
                                        <small>
                                            <span class="me-2">
                                                <i class="fas fa-eye me-1"></i>{{ article.read_count }}
                                            </span>
                                            <span class="me-2">
                                                <i class="fas fa-heart me-1"></i>{{ article.like_count }}
                                            </span>
                                            <span>
                                                <i class="fas fa-comment me-1"></i>{{ article.comment_count }}
                                            </span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    {% else %}
    <!-- 无数据状态 -->
    <div class="text-center py-5">
        <i class="fas fa-chart-line fa-4x text-muted mb-3"></i>
        <h3 class="text-muted mb-3">暂无月度总结</h3>
        <p class="text-muted mb-4">
            还没有生成月度总结，点击下方按钮开始生成
        </p>
        <a href="/generate-summary" class="btn btn-primary btn-lg">
            <i class="fas fa-magic me-2"></i>生成月度总结
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleAllSummaries() {
    const collapses = document.querySelectorAll('.collapse');
    const isAnyExpanded = Array.from(collapses).some(collapse => 
        collapse.classList.contains('show')
    );
    
    collapses.forEach(collapse => {
        if (isAnyExpanded) {
            bootstrap.Collapse.getOrCreateInstance(collapse).hide();
        } else {
            bootstrap.Collapse.getOrCreateInstance(collapse).show();
        }
    });
}

// 自动渲染Markdown内容
document.addEventListener('DOMContentLoaded', function() {
    // 处理Markdown格式的总结内容
    const summaryContents = document.querySelectorAll('.markdown-content');
    summaryContents.forEach(content => {
        let html = content.innerHTML;
        
        // 简单的Markdown转HTML
        html = html.replace(/^### (.*$)/gim, '<h4>$1</h4>');
        html = html.replace(/^## (.*$)/gim, '<h3>$1</h3>');
        html = html.replace(/^# (.*$)/gim, '<h2>$1</h2>');
        html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
        html = html.replace(/^\- (.*$)/gim, '<li>$1</li>');
        html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
        html = html.replace(/\n/g, '<br>');
        
        content.innerHTML = html;
    });
});
</script>
{% endblock %}
